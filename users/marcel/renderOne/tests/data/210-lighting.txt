include renderOne/forward-lighting/light-params.txt
include renderOne/forward-lighting/light-volume.txt

include 210-shadow-lookup.txt

#define DEBUG_LIGHTING_COMPLXITY 0

vec3 calculateLight(int id, vec3 position_view, bool receiveShadows)
{
	vec4 position_light = shadowMatrices[id] * vec4(position_view, 1.0);

	if (position_light.z < 0.0)
		return vec3(0.0);

	vec3 result = vec3(1.0);

	if (receiveShadows)
	{
		result *= lookupShadow(id, position_view);
	}

	result *= 12.0;

	float distance_attenuation = 1.0 / (position_light.z * position_light.z);

	position_light.xy /= position_light.w;
	float spot_attenuation = max(0.0, 1.0 - dot(position_light.xy, position_light.xy));
	//float spot_attenuation = 1.0;

	result *= spot_attenuation * distance_attenuation;

	return result;
}

vec3 s_position_view;
vec3 s_color;
bool s_receiveShadows;

#if DEBUG_LIGHTING_COMPLXITY
int s_numLights;
#endif

void forEachLightId(int id)
{
	LightParams light = lookupLightParams(id);
		
	s_color += light.color * calculateLight(id, s_position_view, s_receiveShadows && light.userData != -1.0);

#if DEBUG_LIGHTING_COMPLXITY
	s_numLights++;
#endif
}

vec3 calculateLighting(vec3 position_view, bool receiveShadows)
{
	vec3 color = vec3(0.0);

#if 1
	s_position_view = position_view;
	s_color = vec3(0.0);
	s_receiveShadows = receiveShadows;

#if DEBUG_LIGHTING_COMPLXITY
	s_numLights = 0;
#endif

	forEachLightIdAt(position_view);

	color = s_color;

#if DEBUG_LIGHTING_COMPLXITY
	color += vec3(s_numLights / 16.0);
#endif
#elif 1
	int i_numLights = int(numLights);

	for (int i = 0; i < i_numLights; ++i)
	{
		LightParams light = lookupLightParams(i);
		
		color += light.color * calculateLight(i, position_view, receiveShadows && light.userData != -1.0);
	}
#else
	color += vec3(1, 1, 0) * calculateLight(0, position_view, receiveShadows);
	color += vec3(0, 1, 1) * calculateLight(1, position_view, receiveShadows);
	color += vec3(1, 0, 1) * calculateLight(2, position_view, receiveShadows);
#endif

	color /= 3.0;

	color += vec3(0.01);

	return color;
}

include engine/ShaderPS.txt
include light-params.txt
include light-volume-utils.txt

shader_in vec3 v_position;
shader_in vec4 v_color;

//

uniform float useLightVolume;

//

vec3 computeLighting(LightParams lightParams, vec3 position)
{
	float distance = length(position - lightParams.position);

	distance = (distance - lightParams.attenuationBegin) / (lightParams.attenuationEnd - lightParams.attenuationBegin);
	distance = clamp(distance, 0.0, 1.0);
	
	float attenuation = 1.0 - distance;

	return lightParams.color * attenuation;
}

//

vec3 lightColor;

void forEachLightId(int id)
{
	LightParams lightParams = lookupLightParams(id);

	lightColor += computeLighting(lightParams, v_position);
}

void main()
{
	lightColor = vec3(0.0);

	if (useLightVolume == 0.0)
	{
		for (int i = 0; i < int(numLights); ++i)
			forEachLightId(i);
	}
	else
	{
		forEachLightIdAt(v_position);
	}

	shader_fragColor.rgb = lightColor * v_color.rgb;
	shader_fragColor.a = v_color.a;
}

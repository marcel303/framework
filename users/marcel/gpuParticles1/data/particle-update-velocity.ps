include engine/ShaderPS.txt

uniform sampler2D p;
uniform sampler2D v;

uniform sampler2D flowfield;

uniform float drag;
uniform vec2 grav_pos;

uniform float grav_force;

shader_in float texcoord;

float flow_strength = 1.0;
void main()
{
	vec2 position = texture(p, vec2(texcoord, 0.0)).xy;
	vec2 velocity = texture(v, vec2(texcoord, 0.0)).xy;

	// apply gravitational force

	vec2 delta = grav_pos - position;
	velocity += normalize(delta) / length(delta) * grav_force;

	// apply flowfield acceleration

	vec2 flow = texture(flowfield, position / textureSize(flowfield, 0)).xy;
	velocity += flow * flow_strength;

	velocity *= drag;

	shader_fragColor = vec4(velocity, 0.0, 0.0);
}